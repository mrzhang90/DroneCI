---
title: 双线程架构
date: 2022-05-22 23:18:06
permalink: /pages/bc5e61/
categories:
  - 小程序
tags:
  - 
author: 
  name: 张广森
  link: https://github.com/mrzhang90
---
微信小程序的线程分为逻辑层和渲染层，渲染层界面使用 webview进行渲染；逻辑层采用 JSCore 运行 javascript 代码，这两个线程由 Native 层进行统一处理，无论线程之间的通讯、数据的传递、网络的请求都由 Native 做转发

## 为什么要做多个 webview
一个渲染层有多个界面，就有多个 webview，这样是为了更接近原生应用 APP 的用户体验

webview 是手机内置的 webkit内核浏览器

## 为什么要做Native层
首先第一个问题，js 是有单线程阻塞的问题；第二个问题是，如果所有的资源都是请求来获取，那么不仅会阻塞 js 解析的事件，还要加上 js 请出去的时间，请求资源时间不可控怎么办，这个时候就有个选择至关重要，就是缓存。

在开发微信公众号H5的时候，我们是需要手动注入微信 SDK 到项目中，这里就有个问题，就是会抢占渲染资源，所以小程序是将微信 SDK 放到了 Native 层，而且还有底层基础库、Service等，等页面加载的时候，再由 Native 动态注入到视图层，这样就减少了包的大小，而且减少了网络请求

## 为什么要逻辑层
因为 js 太灵活，可以随意跳转路由、可以通过操作 DOM 获取小程序内部敏感数据，为了解决这个问题就需要提供一个沙箱环境来运行 javascript 代码，得益于客户端的 Javascript 解释引擎(IOS内置的 javascriptCore 框架、Android 则是腾讯 X5 内核提供的 JS core 环境),由此创建一个单独的线程去执行 javascript，在这个环境下执行的都是有关小程序业务逻辑的代码，也就是逻辑层

## 总结
界面渲染相关的任务都在 webview线程里执行，通过逻辑层控制渲染哪些界面，这一层就是渲染层，这就是双线程模型的由来。

这两个线程由 Native 层统一处理，无论是线程之间的通讯、数据的传递、网络的请求，都有 Native 层转发。

双线程的好处不仅仅是一分为二而已，还有强大的Native层做背后支撑